name: Release

on:
    workflow_dispatch:
        inputs:
            new_version:
                description: "New version (e.g., v1.2.3)"
                required: true

jobs:
    bump-version-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Generate token
              id: app-token
              uses: actions/create-github-app-token@v1
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.PRIVATE_KEY }}

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: develop

            - name: Set up Git
              run: |
                  git config --global user.name 'github-actions[bot]'
                  git config --global user.email 'github-actions[bot]@users.noreply.github.com'

            - name: Bump version in version.go
              run: |
                  sed -i.bak 's/^const VERSION = ".*"/const VERSION = "${{ github.event.inputs.new_version }}"/' version/version.go
                  rm version/version.go.bak

            - name: Commit and push version bump
              run: |
                  git add version/version.go
                  git commit -m "chore: bump version to ${{ github.event.inputs.new_version }}"
                  git push origin HEAD:develop

            - name: Create release branch
              run: |
                  git checkout -b ${{ github.event.inputs.new_version }}
                  git push origin ${{ github.event.inputs.new_version }}

            - name: Push release branch to main
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  git fetch origin
                  git checkout ${{ github.event.inputs.new_version }}
                  git config user.name "${{ vars.BOT_NAME }}[bot]"
                  git config user.email "${{ secrets.APP_ID }}+${{ vars.BOT_NAME }}[bot]@users.noreply.github.com"
                  git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} ${{ github.event.inputs.new_version }}:main

            - name: Create tag
              run: |
                  git tag ${{ github.event.inputs.new_version }}
                  git push origin ${{ github.event.inputs.new_version }}

            - name: Create GitHub Release (auto notes)
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.event.inputs.new_version }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
