name: Release

on:
    workflow_dispatch:
        inputs:
            new_version:
                description: "New version (e.g., v1.2.3)"
                required: true
    push:
        branches:
            - main

jobs:
    bump-version:
        runs-on: ubuntu-latest
        steps:
            - name: Generate token
              id: app-token
              uses: actions/create-github-app-token@v1
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.PRIVATE_KEY }}

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: develop

            - name: Set up Git
              run: |
                  git config --global user.name 'github-actions[bot]'
                  git config --global user.email 'github-actions[bot]@users.noreply.github.com'

            - name: Bump version in version.go
              run: |
                  sed -i.bak 's/^const VERSION = ".*"/const VERSION = "${{ github.event.inputs.new_version }}"/' version/version.go
                  rm version/version.go.bak

            - name: Commit and push version bump
              run: |
                  git add version/version.go
                  git commit -m "chore: bump version to ${{ github.event.inputs.new_version }}"
                  git push origin HEAD:develop

            - name: Create release branch
              run: |
                  git checkout -b ${{ github.event.inputs.new_version }}
                  git push origin ${{ github.event.inputs.new_version }}

            - name: Create PR from release branch to main
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ steps.app-token.outputs.token }}
                  base: main
                  title: "Release ${{ github.event.inputs.new_version }}"
                  body: "Automated release PR for ${{ github.event.inputs.new_version }}"

    release-on-main:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get latest version from version.go
              id: get_version
              run: |
                  VERSION=$(grep '^const VERSION' version/version.go | sed -E 's/.*"(.*)".*/\1/')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Create tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag ${{ steps.get_version.outputs.version }}
                  git push origin ${{ steps.get_version.outputs.version }}

            - name: Create GitHub Release (auto notes)
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.get_version.outputs.version }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
